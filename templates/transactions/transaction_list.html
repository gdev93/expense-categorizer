{% extends "main/index.html" %}
{% load static %}

{% block title %}Transaction List{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/transactions.css' %}">
{% endblock %}

{% block content %}
    <div class="container mt-5">
        <div class="header">
            <h1>üí∞ Transactions</h1>
            <a href="{% url 'transactions_upload' %}" class="upload-btn">üì§ Upload New CSV</a>
        </div>

        <!-- Summary Cards -->
        {% if transactions %}
            <div class="summary">
                <div class="summary-card">
                    <div class="summary-label">Total Transactions</div>
                    <div class="summary-value">{{ total_count }}</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">Total Amount</div>
                    <div class="summary-value">‚Ç¨{{ total_amount|floatformat:2 }}</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">Categories</div>
                    <div class="summary-value">{{ category_count }}</div>
                </div>
            </div>
        {% endif %}

        <!-- Filters -->
        <form method="get" class="filters">
            <div class="filter-group">
                <label for="category">Category</label>
                <select name="category" id="category" onchange="this.form.submit()">
                    <option value="">All Categories</option>
                    {% for cat in categories %}
                        <option value="{{ cat.id }}"
                                {% if selected_category == cat.id|stringformat:"s" %}selected{% endif %}>
                            {{ cat.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="filter-group">
                <label for="status">Status</label>
                <select name="status" id="status" onchange="this.form.submit()">
                    <option value="">All Statuses</option>
                    <option value="pending" {% if selected_status == "pending" %}selected{% endif %}>Pending</option>
                    <option value="categorized" {% if selected_status == "categorized" %}selected{% endif %}>
                        Categorized
                    </option>
                    <option value="reviewed" {% if selected_status == "reviewed" %}selected{% endif %}>Reviewed</option>
                </select>
            </div>

            <div class="filter-group">
                <label for="search">Search</label>
                <input type="text" name="search" id="search" placeholder="Search merchant or description..."
                       value="{{ search_query }}"/>
            </div>

            <div class="filter-group" style="align-self: flex-end;">
                <button type="submit" class="btn btn-primary">Filter</button>
                <a href="{% url 'transaction_list' %}" class="btn btn-secondary">Clear</a>
            </div>
        </form>

        <!-- Transaction List -->
        {% if categories %}
            <div class="categories">
            {% for category in categories %}
                <div class="category-tag">
                    {{ category.name }}
                </div>
            {% endfor %}
            </div>
        {% endif %}
        {% if transactions %}
            <div class="transaction-list">
                {% for transaction in transactions %}
                    <div class="transaction-item">
                        <div class="transaction-main">
                            <div class="transaction-date">
                                üìÖ {{ transaction.transaction_date|date:"d/m/Y" }}
                                {% if transaction.modified_by_user %}
                                    <span style="color: #2196f3; font-size: 11px;">‚úèÔ∏è Edited</span>
                                {% endif %}
                            </div>
                            <div class="transaction-merchant">
                                {{ transaction.merchant_raw_name|default:"Unknown Merchant" }}
                            </div>
                            {% if transaction.description %}
                                <div class="transaction-description" title="{{ transaction.description }}">
                                    {{ transaction.description|truncatewords:15 }}
                                </div>
                            {% endif %}
                        </div>

                        <div class="transaction-meta">
                            {% if transaction.category %}
                                <span class="transaction-category">{{ transaction.category.name }}</span>
                            {% endif %}

                            <span class="transaction-status status-{{ transaction.status }}">
                    {{ transaction.get_status_display }}
                </span>

                            <div class="transaction-amount">
                                ‚Ç¨{{ transaction.amount|floatformat:2 }}
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>

            <!-- Pagination -->
            {% if is_paginated %}
                <div class="pagination">
                    {% if page_obj.has_previous %}
                        <a href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if selected_status %}&status={{ selected_status }}{% endif %}">¬´
                            First</a>
                        <a href="?page=


                                {{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if selected_status %}&status={{ selected_status }}{% endif %}">‚Äπ
                            Previous</a>
                    {% else %}
                        <span class="disabled">¬´ First</span>
                        <span class="disabled">‚Äπ Previous</span>
                    {% endif %}

                    <span class="current">
            Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
        </span>

                    {% if page_obj.has_next %}
                        <a href="?page=


                                {{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if selected_status %}&status={{ selected_status }}{% endif %}">Next
                            ‚Ä∫</a>
                        <a href="?page=


                                {{ page_obj.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if selected_status %}&status={{ selected_status }}{% endif %}">Last
                            ¬ª</a>
                    {% else %}
                        <span class="disabled">Next ‚Ä∫</span>
                        <span class="disabled">Last ¬ª</span>
                    {% endif %}
                </div>
            {% endif %}

        {% else %}
            <!-- Empty State -->
            <div class="empty-state">
                <div class="empty-state-icon">üì≠</div>
                <h3>No Transactions Found</h3>
                <p>Upload a CSV file to get started with expense tracking.</p>
                <a href="{% url 'transactions_upload' %}" class="btn btn-primary" style="margin-top: 20px;">
                    üì§ Upload CSV
                </a>
            </div>
        {% endif %}
    </div>
{% endblock %}