{% extends "main/index.html" %}
{% load static %}

{% block title %}Lista Transazioni{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/transactions.css' %}">
{% endblock %}

{% block content %}
    <div class="container mt-5">
        <div class="header">
            <h1>üí∞ Transazioni</h1>
            <a href="{% url 'transactions_upload' %}" class="upload-btn">üì§ Carica Nuovo CSV</a>
        </div>

        <!-- Summary Cards -->
        {% if transactions %}
            <div class="summary">
                <div class="summary-card">
                    <div class="summary-label">Totale Transazioni</div>
                    <div class="summary-value">{{ total_count }}</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">Importo Totale</div>
                    <div class="summary-value">‚Ç¨{{ total_amount|floatformat:2 }}</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">Categorie</div>
                    <div class="summary-value">{{ category_count }}</div>
                </div>
            </div>
        {% endif %}

        <!-- Filters -->
        <form method="get" class="filters">
            <div class="filter-group">
                <label for="category">Categoria</label>
                <select name="category" id="category" onchange="this.form.submit()">
                    <option value="">Tutte le Categorie</option>
                    {% for cat in categories %}
                        <option value="{{ cat.id }}"
                                {% if selected_category == cat.id|stringformat:"s" %}selected{% endif %}>
                            {{ cat.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="filter-group">
                <label for="status">Stato</label>
                <select name="status" id="status" onchange="this.form.submit()">
                    <option value="">Tutti gli Stati</option>
                    <option value="pending" {% if selected_status == "pending" %}selected{% endif %}>In Attesa</option>
                    <option value="categorized" {% if selected_status == "categorized" %}selected{% endif %}>
                        Categorizzata
                    </option>
                    <option value="reviewed" {% if selected_status == "reviewed" %}selected{% endif %}>Revisionata</option>
                </select>
            </div>

            <div class="filter-group">
                <label for="search">Ricerca</label>
                <input type="text" name="search" id="search" placeholder="Cerca merchant o descrizione..."
                       value="{{ search_query }}"/>
            </div>

            <div class="filter-group" style="align-self: flex-end;">
                <button type="submit" class="btn btn-primary">Filtra</button>
                <a href="{% url 'transaction_list' %}" class="btn btn-secondary">Cancella</a>
            </div>
        </form>

        <!-- Categories -->
        {% if categories %}
            <div class="categories">
                {% for category in categories %}
                    <td class="category-cell">
                        <span class="category-pill" onclick="window.location.href='{% url 'transaction_list' %}'">
                            {{ category.name|default:"Non Categorizzata" }}
                        </span>
                    </td>
                {% endfor %}
            </div>
        {% endif %}

        <!-- Categorization Rules Section -->
        <div class="expander-card mb-4">
            <div class="expander-header" id="ruleExpanderHeader" onclick="toggleExpander('ruleExpanderHeader')">
                <div class="expander-title-group">
                    <h2>üéØ Regole di Categorizzazione</h2>
                    <p class="mb-0 text-muted rule-subtitle">Crea regole per associare automaticamente i merchant alle
                        categorie</p>
                </div>
                <button class="expander-toggle-btn" aria-expanded="false" aria-controls="ruleExpanderBody">
                    <span class="expander-icon">‚ñº</span>
                </button>
            </div>

            <div class="expander-body collapsed" id="ruleExpanderBody">

                <div class="mb-4">
                    <h5>Regole esistenti:</h5>
                    {% if rules %}
                        <ul class="list-group rule-list">
                            {% for rule in rules %}
                                <li class="list-group-item rule-item d-flex justify-content-between align-items-center">
                            <span class="rule-text">
                                Tutte le operazioni che riguardano <strong
                                    class="rule-merchant-highlight">{{ rule.merchant.name }}</strong>
                                vanno nella categoria <strong
                                    class="rule-category-highlight">{{ rule.category.name }}</strong>
                            </span>
                                    <form method="post" action="" style="display: inline; margin: 0;">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-sm btn-danger-custom"
                                                onclick="return confirm('Sei sicuro di voler eliminare questa regola?');">
                                            üóëÔ∏è Elimina
                                        </button>
                                    </form>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-muted empty-state-rule">
                            üìã Nessuna regola definita. Crea la tua prima regola qui sotto!
                        </p>
                    {% endif %}
                </div>

                <div class="new-rule-section">
                    <h5>‚ú® Crea nuova regola:</h5>
                    <form method="post" action="{% url 'define_rule' %}" class="mt-3">
                        {% csrf_token %}

                        <div class="rule-builder">
                            <div class="rule-builder-controls">
                                <span class="rule-builder-text">Tutte le operazioni che riguardano</span>

                                <input type="text"
                                       name="merchant_name"
                                       id="new_rule_merchant"
                                       class="form-control rule-input"
                                       placeholder="nome merchant"
                                       required/>

                                <span class="rule-builder-text">vanno nella categoria</span>

                                <input type="text"
                                       name="category_name"
                                       id="new_rule_category"
                                       class="form-control rule-input"
                                       placeholder="categoria"
                                       list="category_suggestions"
                                       required/>

                                <datalist id="category_suggestions">
                                    {% for cat in categories %}
                                        <option value="{{ cat.name }}">
                                    {% endfor %}
                                </datalist>

                                <button type="submit" class="btn btn-primary-gold">
                                    ‚ûï Aggiungi Regola
                                </button>
                            </div>

                            <small class="form-text text-muted d-block mt-3 rule-tip">
                                üí° <strong>Suggerimento:</strong> Puoi inserire un nome di categoria esistente dal menu a
                                tendina, oppure digitare un nuovo nome per creare una nuova categoria.
                            </small>
                        </div>
                    </form>
                </div>
            </div>
        </div>


        <!-- Uncategorized Transactions Section -->
        <div class="uncategorized-section" style="margin-bottom: 40px;">
            <h2 style="margin-bottom: 20px;">
                üè∑Ô∏è Transazioni Non Categorizzate
                <span class="badge"
                      style="background-color: #ffc107; color: #000; padding: 4px 8px; border-radius: 12px; font-size: 14px;">
            {{ uncategorized_transaction.count }}
        </span>
            </h2>

            <div class="transaction-list">
                {% for transaction in uncategorized_transaction %}
                    <div class="transaction-item"
                         onclick="window.location.href='{% url 'transaction_detail' transaction.id %}'">
                        <div class="transaction-main">
                            <div class="transaction-date">
                                üìÖ {{ transaction.transaction_date|date:"d/m/Y" }}
                            </div>
                        {% if transaction.merchant_raw_name %}
                            <div class="transaction-merchant">
                                {{ transaction.merchant_raw_name }}
                            </div>
                        {% endif %}
                            {% if transaction.description %}
                                <div class="transaction-description" title="{{ transaction.description }}">
                                    {{ transaction.description|truncatewords:15 }}
                                </div>
                            {% endif %}
                        </div>

                        <div class="transaction-meta">
                    <span class="transaction-category" style="background-color: #ffc107; color: #000;">
                        Non Categorizzata
                    </span>

                            <span class="transaction-status status-{{ transaction.status }}">
                        {{ transaction.get_status_display }}
                    </span>

                            <div class="transaction-amount">
                                ‚Ç¨{% if transaction.original_amount|slice:":1" == '+' %}
                                {{ transaction.original_amount|slice:"1:" }}
                            {% else %}
                                {{ transaction.original_amount }}
                            {% endif %}
                            </div>
                        </div>
                    </div>
                {% empty %}
                    {% if transactions %}
                        <div class="transaction-item" style="text-align: center; color: #999;">
                            ‚úÖ Tutte le transazioni sono categorizzate!
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        <!-- Transaction List -->
        {% if transactions %}
            <h2 style="margin-bottom: 20px;">üìä Transazioni Categorizzate</h2>

            <div class="transaction-list">
                {% for transaction in transactions %}
                    <div class="transaction-item" onclick="window.location.href='{% url 'transaction_detail' transaction.id %}'">
                        <div class="transaction-main">
                            <div class="transaction-date">
                                üìÖ {{ transaction.transaction_date|date:"d/m/Y" }}
                            </div>
                            <div class="transaction-merchant">
                                {{ transaction.merchant_raw_name|default:"Merchant Sconosciuto" }}
                            </div>
                            {% if transaction.description %}
                                <div class="transaction-description" title="{{ transaction.description }}">
                                    {{ transaction.description|truncatewords:15 }}
                                </div>
                            {% endif %}
                        </div>

                        <div class="transaction-meta">
                            {% if transaction.category %}
                                <span class="transaction-category"
                                      data-transaction-id="{{ transaction.id }}"
                                      data-current-category-id="{{ transaction.category.id }}"
                                      onclick="makeSelectable(this)">
                    {{ transaction.category.name }}
                </span>
                            {% endif %}

                            <span class="transaction-status status-{{ transaction.status }}">
                    {{ transaction.get_status_display }}
                </span>

                            <div class="transaction-amount">
                                ‚Ç¨{{ transaction.amount|floatformat:2 }}
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>

            <!-- Pagination -->
            {% if is_paginated %}
                <div class="pagination">
                    {% if page_obj.has_previous %}
                        <a href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if selected_status %}&status={{ selected_status }}{% endif %}">¬´
                            Prima</a>
                        <a href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if selected_status %}&status={{ selected_status }}{% endif %}">‚Äπ
                            Precedente</a>
                    {% else %}
                        <span class="disabled">¬´ Prima</span>
                        <span class="disabled">‚Äπ Precedente</span>
                    {% endif %}

                    <span class="current">
            Pagina {{ page_obj.number }} di {{ page_obj.paginator.num_pages }}
        </span>

                    {% if page_obj.has_next %}
                        <a href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if selected_status %}&status={{ selected_status }}{% endif %}">Successiva
                            ‚Ä∫</a>
                        <a href="?page={{ page_obj.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if selected_status %}&status={{ selected_status }}{% endif %}">Ultima
                            ¬ª</a>
                    {% else %}
                        <span class="disabled">Successiva ‚Ä∫</span>
                        <span class="disabled">Ultima ¬ª</span>
                    {% endif %}
                </div>
                {{ categories|json_script:"category-data" }}
                <script>
                    // URL is now set correctly for the transaction update endpoint
                    const BASE_EDIT_TRANSACTION_URL = '{% url 'update_transaction_category' %}';
                    const EDIT_TRANSACTION_CATEGORY_CSRF_TOKEN = "{{ csrf_token }}";
                    const CATEGORY_OPTIONS = JSON.parse(document.getElementById('category-data').textContent)
                </script>
                <script src="{% static 'js/clickable-transaction-form-input.js' %}"></script>
            {% endif %}

        {% else %}
            <!-- Empty State -->
            <div class="empty-state">
                <div class="empty-state-icon">üì≠</div>
                <h3>Nessuna Transazione Trovata</h3>
                <p>Carica un file CSV per iniziare a tracciare le tue spese.</p>
                <a href="{% url 'transactions_upload' %}" class="btn btn-primary" style="margin-top: 20px;">
                    üì§ Carica CSV
                </a>
            </div>
        {% endif %}
    </div>
<script src="{% static 'js/expander.js' %}"></script>
{% endblock %}