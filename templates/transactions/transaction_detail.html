{% extends "main/index.html" %}
{% load static %}

{% block title %}Dettaglio Transazione{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/transactions.css' %}">
    <link rel="stylesheet" href="{% static 'css/categories.css' %}">
{% endblock %}

{% block content %}
    <div class="container mt-2">
        <div class="header">
            <div class="header-title-container">
                <h1>üìù Dettaglio Transazione</h1>
            </div>
            <div class="header-actions">
                <div class="d-flex align-items-center gap-3">
                    <a href="#" onclick="smartBack(); return false;" class="btn btn-secondary">
                        Indietro
                    </a>
                    <button type="submit" form="transaction-form" name="delete" class="btn btn-icon btn-icon-danger" title="Elimina"
                            onclick="return confirm('Sei sicuro di voler eliminare questa transazione? Questa azione non √® reversibile.')">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 6h18"></path>
                            <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                            <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                            <line x1="10" y1="11" x2="10" y2="17"></line>
                            <line x1="14" y1="11" x2="14" y2="17"></line>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <div class="mt-4 mt-4-mobile">
            <div class="mobile-only">
                <div class="form-actions mb-4">
                    <button type="submit" form="transaction-form" class="btn btn-primary">
                        üíæ Salva Modifiche
                    </button>
                </div>
            </div>
            <div class="detail-card">
                <div class="detail-header">
                    <h2>Informazioni Generali</h2>
                    <span class="transaction-status status-{{ transaction.status }}">
                        {{ transaction.get_status_display }}
                    </span>
                </div>

                <div class="detail-body">
                    <form method="post" action="{% url 'transaction_detail' transaction.id %}" class="category-form" id="transaction-form">
                        {% csrf_token %}
                        <input type="hidden" name="apply_to_all" id="apply_to_all" value="false">

                        <div class="text-center amount-section">
                            <div class="amount-highlight {% if transaction.transaction_type == 'income' %}is-income{% endif %}">
                                ‚Ç¨ {{ transaction.amount|floatformat:2 }}
                            </div>
                            <div class="amount-date">
                                <span class="nav-icon">üìÖ</span> {{ transaction.transaction_date|date:"d F Y" }}
                            </div>
                        </div>

                        <div class="form-grid">
                            <div class="form-group col-span-2-mobile">
                                <label class="field-label" for="id_merchant_raw_name">
                                    <span>üè¢</span> Nome Esercente
                                </label>
                                <input type="text" name="merchant_raw_name" id="id_merchant_raw_name"
                                       class="form-control" value="{{ transaction.merchant.name|default:"" }}" required />
                            </div>

                            <div class="form-group">
                                <label class="field-label" for="id_amount">
                                    <span>üí∞</span> Importo (‚Ç¨)
                                </label>
                                <input type="number" name="amount" id="id_amount" step="0.01"
                                       class="form-control" value="{{ transaction.amount|floatformat:2 }}" required />
                            </div>

                            <div class="form-group">
                                <label class="field-label" for="id_transaction_date">
                                    <span>üìÖ</span> Data Operazione
                                </label>
                                <input type="date" name="transaction_date" id="id_transaction_date"
                                       class="form-control" value="{{ transaction.transaction_date|date:'Y-m-d' }}" required />
                            </div>

                            
                        </div>

                        <div class="form-group mb-4">
                            <label class="field-label" for="id_description">
                                <span>üìÑ</span> Descrizione Originale (Banca)
                            </label>
                            <textarea id="id_description" name="description" class="form-control description-textarea" rows="3">{{ transaction.description|default:"" }}</textarea>
                        </div>

                        <div class="divider"></div>

                        <div class="section-title">
                            <span>üìÇ</span> Categorizzazione
                        </div>

                        <div class="form-group mb-3">
                            <label class="field-label" for="id_category">Seleziona Categoria</label>
                            <select name="category" id="id_category" class="form-control" required>
                                <option value="">Seleziona Categoria</option>
                                {% for cat in categories %}
                                    <option value="{{ cat.id }}"
                                            {% if transaction.category.id == cat.id %}selected{% endif %}>
                                        {{ cat.name }}
                                    </option>
                                {% endfor %}
                            </select>
                            <small class="form-text text-muted">
                                Scegli una delle categorie esistenti per questa spesa.
                            </small>
                        </div>

                        <div class="new-category-box">
                            <label class="field-label field-label-highlight" for="id_new_category_name">
                                <span>‚ú®</span> Crea Nuova Categoria
                            </label>
                            <input type="text" name="new_category_name" id="id_new_category_name"
                                   class="form-control" placeholder="Inserisci nome (es: Regali, Salute...)" />
                            <small class="form-text help-text-highlight">
                                Se compilato, verr√† creata una nuova categoria e assegnata automaticamente.
                            </small>
                        </div>

                        <div class="desktop-only">
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">
                                    üíæ Salva Modifiche
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block modals %}
    <!-- Modal for applying category to all previous transactions -->
    <div id="categoryModal" class="app-modal" style="display: none;">
        <div class="app-modal-content">
            <div class="app-modal-header">
                <h3>Aggiorna transazioni precedenti?</h3>
            </div>
            <div class="app-modal-body">
                <p>Vuoi applicare questa categoria a tutte le transazioni di <strong id="modal-merchant-name">{{ transaction.merchant.name|default:transaction.merchant_raw_name }}</strong>?</p>
            </div>
            <div class="app-modal-footer">
                <button type="button" id="btnOnlyThis" class="btn btn-secondary">Solo questa</button>
                <button type="button" id="btnApplyAll" class="btn btn-primary">Applica a tutte</button>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('transaction-form');
        const categorySelect = document.getElementById('id_category');
        const newCategoryInput = document.getElementById('id_new_category_name');
        const merchantInput = document.getElementById('id_merchant_raw_name');

        if (!form || !categorySelect || !newCategoryInput) return;

        const originalCategoryId = categorySelect.value;

        const modal = document.getElementById('categoryModal');
        const btnOnlyThis = document.getElementById('btnOnlyThis');
        const btnApplyAll = document.getElementById('btnApplyAll');
        const applyToAllInput = document.getElementById('apply_to_all');

        let shouldShowModal = true;

        form.addEventListener('submit', function(e) {
            // Avoid showing modal when deleting
            if (e.submitter && e.submitter.name === 'delete') {
                return;
            }

            const currentCategoryId = categorySelect.value;
            const newCategoryName = newCategoryInput.value.trim();
            const currentMerchantName = merchantInput ? merchantInput.value.trim() : '';

            // If category has changed OR a new category name is provided
            const categoryChanged = currentCategoryId !== originalCategoryId || newCategoryName !== '';

            if (categoryChanged && shouldShowModal && modal) {
                // Update merchant name in modal text
                const modalMerchantName = document.getElementById('modal-merchant-name');
                if (modalMerchantName) {
                    modalMerchantName.textContent = currentMerchantName;
                }

                e.preventDefault();
                // Use !important in style to ensure visibility against conflicting CSS
                modal.style.setProperty('display', 'flex', 'important');
            }
        });

        if (btnOnlyThis) {
            btnOnlyThis.onclick = function() {
                if (applyToAllInput) applyToAllInput.value = "false";
                shouldShowModal = false;
                if (modal) modal.style.display = "none";
                form.submit();
            }
        }

        if (btnApplyAll) {
            btnApplyAll.onclick = function() {
                if (applyToAllInput) applyToAllInput.value = "true";
                shouldShowModal = false;
                if (modal) modal.style.display = "none";
                form.submit();
            }
        }

        window.onclick = function(event) {
            if (modal && event.target == modal) {
                modal.style.display = "none";
            }
        }
    });

    function smartBack() {
        if (window.history.length > 1) {
            window.history.back();
        } else {
            window.location.href = "{% url 'transaction_list' %}";
        }
    }
    </script>
{% endblock %}