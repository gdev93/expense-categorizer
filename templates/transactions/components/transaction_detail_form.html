<form method="post" action="{% url 'transaction_detail' transaction.id %}" class="category-form" id="transaction-form">
    {% csrf_token %}

    <div class="text-center amount-section">
        <div class="amount-highlight {% if transaction.transaction_type == 'income' %}is-income{% endif %}">
            € {{ transaction.amount|floatformat:2 }}
        </div>
        <div class="amount-date">
            <span class="material-icons" style="font-size: 1.1em; vertical-align: middle; margin-right: 4px;">calendar_today</span> {{ transaction.transaction_date|date:"d F Y" }}
        </div>
    </div>

    <div class="form-grid">
        <div class="form-group col-span-2-mobile" style="position: relative;">
            <label class="field-label" for="id_merchant_name">
                <span class="material-icons">store</span> Nome Esercente
            </label>
            <input type="text" name="merchant_raw_name" id="id_merchant_name"
                   class="form-control" value="{{ transaction.merchant.name|default:transaction.merchant_raw_name }}" required
                   hx-get="{% url 'merchant_search' %}"
                   hx-trigger="keyup changed delay:500ms"
                   hx-target="#merchant-search-results"
                   autocomplete="off" />
            <div id="merchant-search-results" class="merchant-search-results-container"></div>
        </div>

        <div class="form-group">
            <label class="field-label" for="id_amount">
                <span class="material-icons">payments</span> Importo (€)
            </label>
            <input type="number" name="amount" id="id_amount" step="0.01"
                   class="form-control" value="{{ transaction.amount|floatformat:2 }}" required />
        </div>

        <div class="form-group">
            <label class="field-label" for="id_transaction_date">
                <span class="material-icons">calendar_today</span> Data Operazione
            </label>
            <input type="date" name="transaction_date" id="id_transaction_date"
                   class="form-control" value="{{ transaction.transaction_date|date:'Y-m-d' }}" required />
        </div>

        <div class="form-group">
            <label class="field-label" for="id_category_name">
                <span class="material-icons">category</span> Categoria
            </label>
            <input type="text" name="category_name" id="id_category_name" list="category-list"
                   class="form-control" value="{{ transaction.category.name|default:'' }}" required
                   placeholder="Seleziona o scrivi..." autocomplete="off" />
            <datalist id="category-list">
                {% for cat in categories %}
                    <option value="{{ cat.name }}">
                {% endfor %}
            </datalist>
        </div>
    </div>

    {% if transaction.merchant %}
    <div class="form-group mt-2 mb-4">
        <label class="field-label" style="display: flex; align-items: center; cursor: pointer; font-weight: normal; font-size: 0.95rem; color: #4b5563;">
            <input type="checkbox" name="apply_to_all" id="id_apply_to_all" style="margin-right: 10px; width: 18px; height: 18px;">
            <span>Applica questa categoria a tutte le transazioni di <strong>{{ transaction.merchant.name|default:transaction.merchant_raw_name }}</strong></span>
        </label>
    </div>
    {% endif %}

    <div class="form-group mb-4">
        <label class="field-label" for="id_description">
            <span class="material-icons">description</span> Descrizione Originale (Banca)
        </label>
        <textarea id="id_description" name="description" class="form-control description-textarea" rows="3">{{ transaction.description|default:"" }}</textarea>
    </div>

    <div class="form-actions mt-4">
        <button type="submit" class="btn btn-primary w-100-mobile">
            <span class="material-icons" style="vertical-align: middle; margin-right: 4px;">save</span> Salva Modifiche
        </button>
        <button type="submit" name="delete" class="btn btn-danger w-100-mobile"
                onclick="return confirm('Sei sicuro di voler eliminare questa transazione? Questa azione non è reversibile.')">
            <span class="material-icons" style="vertical-align: middle; margin-right: 4px;">delete</span> Elimina
        </button>
    </div>
</form>

<script>
    // Re-initialize the detail logic if loaded via HTMX
    (function() {
        const initDetailLogic = function() {
            // Placeholder for any initialization logic needed for the detail form
            // currently nothing specific is required here.
        };

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initDetailLogic);
        } else {
            initDetailLogic();
        }
    })();
</script>