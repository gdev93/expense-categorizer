<!-- Uncategorized Transactions Section -->
{% if uncategorized_transaction %}
<h2 class="mb-3">
     Spese Non Categorizzate
    <span class="badge"
          style="background-color: #ffc107; color: #000; padding: 4px 8px; border-radius: 12px; font-size: 14px;">
        {{ uncategorized_transaction.count }}
    </span>
</h2>
<details class="expander-card" style="margin-bottom: 40px;">
    <summary class="expander-header">
        <span style="font-weight: 600; color: #343a40;">Apri</span>
        <div class="expander-toggle-btn">
            <span class="expander-icon">▼</span>
        </div>
    </summary>

    <div class="expander-body">
        <div class="data-list">
            {% for transaction in uncategorized_transaction %}
                <div class="data-list-item"
                     onclick="window.location.href='{% url 'transaction_detail' transaction.id %}'">
                    <div class="list-item-info">
                        <div class="transaction-date">
                             {{ transaction.transaction_date|date:"d/m/Y" }}
                        </div>
                        {% if transaction.merchant %}
                            <div class="transaction-merchant">
                                {{ transaction.merchant.name }}
                            </div>
                        {% endif %}
                        {% if transaction.description %}
                            <div class="transaction-description" title="{{ transaction.description }}">
                                {{ transaction.description|truncatewords:15 }}
                            </div>
                        {% endif %}
                        {% if transaction.upload_file %}
                            <div class="transaction-file-name">
                                 {{ transaction.upload_file.file_name }}
                            </div>
                        {% endif %}
                    </div>

                    <div class="list-item-stats">
                        <div onclick="event.stopPropagation()" style="display: inline-block;">
                            <span class="transaction-category"
                                  data-transaction-id="{{ transaction.id }}"
                                  data-current-category-id=""
                                  onclick="makeSelectable(this,event)">
                                Seleziona<span class="desktop-only"> Categoria</span>
                            </span>
                        </div>
                        <div class="list-amount">
                            €{% if transaction.original_amount|slice:":1" == '+' %}
                            {{ transaction.original_amount|slice:"1:" }}
                        {% else %}
                            {{ transaction.original_amount }}
                        {% endif %}
                        </div>
                    </div>
                </div>
            {% empty %}
                {% if transactions %}
                    <div class="data-list-item" style="text-align: center; color: #999;">
                         Tutte le spese sono categorizzate!
                    </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>
</details>
{% endif %}

<!-- Transaction List -->
{% if transactions %}
    <h2 class="mb-3"> Spese Categorizzate</h2>

    <div class="data-list" id="scroll-target">
        {% for transaction in transactions %}
            <div class="data-list-item"
                 onclick="window.location.href='{% url 'transaction_detail' transaction.id %}'">
                <div class="list-item-info">
                    <div class="transaction-date">
                         {{ transaction.transaction_date|date:"d/m/Y" }}
                    </div>
                    <div class="transaction-merchant">
                        {{ transaction.merchant.name|default:"Merchant Sconosciuto" }}
                    </div>
                    {% if transaction.upload_file %}
                        <div class="transaction-file-name">
                             {{ transaction.upload_file.file_name }}
                        </div>
                    {% endif %}
                </div>

                <div class="list-item-stats">
                    {% if transaction.category %}
                        <div onclick="event.stopPropagation()" style="display: inline-block;">
                            <span class="transaction-category"
                                  data-transaction-id="{{ transaction.id }}"
                                  data-current-category-id="{{ transaction.category.id }}"
                                  onclick="makeSelectable(this,event)">
                                {{ transaction.category.name }}
                            </span>
                        </div>
                    {% endif %}

                    <div class="list-amount">
                        €{{ transaction.amount|floatformat:2 }}
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if is_paginated %}
<div class="pagination">
{% if page_obj.has_previous %}
    <a href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if selected_upload_file %}&upload_file={{ selected_upload_file }}{% endif %}{% if selected_status %}&status={{ selected_status }}{% endif %}{% for month in selected_months %}&months={{ month }}{% endfor %}{% if year %}&year={{ year }}{% endif %}{% if selected_amount %}&amount={{ selected_amount }}&amount_operator={{ selected_amount_operator }}{% endif %}{% if view_type %}&view_type={{ view_type }}{% endif %}">«
        Prima</a>
    <a href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if selected_upload_file %}&upload_file={{ selected_upload_file }}{% endif %}{% if selected_status %}&status={{ selected_status }}{% endif %}{% for month in selected_months %}&months={{ month }}{% endfor %}{% if year %}&year={{ year }}{% endif %}{% if selected_amount %}&amount={{ selected_amount }}&amount_operator={{ selected_amount_operator }}{% endif %}{% if view_type %}&view_type={{ view_type }}{% endif %}">‹
        Precedente</a>
{% else %}
    <span class="disabled">« Prima</span>
    <span class="disabled">‹ Precedente</span>
{% endif %}

<span class="current">
    Pagina {{ page_obj.number }} di {{ page_obj.paginator.num_pages }}
</span>

{% if page_obj.has_next %}
    <a href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if selected_upload_file %}&upload_file={{ selected_upload_file }}{% endif %}{% if selected_status %}&status={{ selected_status }}{% endif %}{% for month in selected_months %}&months={{ month }}{% endfor %}{% if year %}&year={{ year }}{% endif %}{% if selected_amount %}&amount={{ selected_amount }}&amount_operator={{ selected_amount_operator }}{% endif %}{% if view_type %}&view_type={{ view_type }}{% endif %}">Successiva
        ›</a>
    <a href="?page={{ page_obj.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if selected_upload_file %}&upload_file={{ selected_upload_file }}{% endif %}{% if selected_status %}&status={{ selected_status }}{% endif %}{% for month in selected_months %}&months={{ month }}{% endfor %}{% if year %}&year={{ year }}{% endif %}{% if selected_amount %}&amount={{ selected_amount }}&amount_operator={{ selected_amount_operator }}{% endif %}{% if view_type %}&view_type={{ view_type }}{% endif %}">Ultima
        »</a>
{% else %}
    <span class="disabled">Successiva ›</span>
    <span class="disabled">Ultima »</span>
{% endif %}
</div>
{% endif %}

{% else %}
    <!-- Empty State -->
    {% url 'transactions_upload' as upload_url %}
    {% include "components/empty-state.html" with icon="receipt_long" title="Nessuna Transazione Trovata" description="Carica un file Excel o CSV per iniziare a tracciare le tue spese." button_text="Carica File" button_url=upload_url %}
{% endif %}
