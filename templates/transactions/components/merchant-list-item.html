{% load query_tags %}
{% with m_id=item.merchant__id|default:"none" %}
<div class="merchant-group">
    <div class="data-list-item merchant-clickable"
         hx-get="{% url 'transactions_by_merchant' %}?{% query_transform merchant_id=m_id page=None %}"
         hx-target="#details-{{ m_id }} .expansion-content"
         hx-indicator="#details-{{ m_id }} .htmx-indicator"
         hx-trigger="load-transactions"
         onclick="
            const panel = document.getElementById('details-{{ m_id }}');
            if (panel.classList.contains('is-open')) {
                panel.classList.remove('is-open');
                this.classList.remove('is-active');
            } else {
                document.querySelectorAll('.merchant-details-expansion.is-open').forEach(p => p.classList.remove('is-open'));
                document.querySelectorAll('.data-list-item.is-active').forEach(i => i.classList.remove('is-active'));
                panel.classList.add('is-open');
                this.classList.add('is-active');
                if (!panel.querySelector('.mini-transaction-row') && !this.classList.contains('htmx-request')) {
                    htmx.trigger(this, 'load-transactions');
                }
            }
         ">

        <div class="list-item-info">
            <div class="transaction-merchant">
                {{ item.merchant__name|default:"Sconosciuto" }}
            </div>
            <div class="merchant-meta">
                <span class="badge-count">
                    <span class="material-icons" style="font-size: 0.9rem; vertical-align: middle; margin-right: 4px;">receipt_long</span>
                    {{ item.number_of_transactions }} transazioni
                </span>
            </div>
        </div>
        <div class="list-item-stats">
            <div class="merchant-category-selection" onclick="event.stopPropagation()">
                <form method="post" class="quick-category-form">
                    {% csrf_token %}
                    <input type="hidden" name="merchant_id" value="{{ item.merchant__id }}">
                    <div class="category-pill-container">
                        <span class="transaction-category"
                              onclick="toggleCategoryMenu(this)"
                              style="cursor: pointer;">
                            {% if item.categories_list %}{{ item.categories_list }}{% else %}Seleziona<span class="desktop-only"> Categoria</span>{% endif %}
                        </span>
                        <div class="category-dropdown-menu">
                            {% for cat in categories %}
                                <div class="category-dropdown-item {% if cat.id == item.category_id %}active{% endif %}"
                                     onclick="selectQuickCategory(this, '{{ cat.id }}')">
                                    {{ cat.name }}
                                </div>
                            {% endfor %}
                        </div>
                        <input type="hidden" name="new_category_id" value="{{ item.category_id }}">
                    </div>
                </form>
            </div>
            <div class="list-amount">â‚¬{{ item.total_spent|floatformat:2 }}</div>
        </div>
        <span class="material-icons list-item-chevron">chevron_right</span>
    </div>

    <div class="merchant-details-expansion" id="details-{{ m_id }}">
        <div class="expansion-content">
            <div class="htmx-indicator" style="padding: 10px;">
                <p class="text-muted"><span class="material-icons spin-animation" style="font-size: 1.2rem; vertical-align: middle; margin-right: 8px;">sync</span>Caricamento transazioni...</p>
            </div>
        </div>
    </div>
</div>
{% endwith %}