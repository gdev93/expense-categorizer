{% extends "main/index.html" %}

{% load static %}
{% load time_filters %}

{% block title %}Caricamento dati{% endblock %}
{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/upload.css' %}">
    <link rel="stylesheet" href="{% static 'css/list.css' %}">
    <link rel="stylesheet" href="{% static 'css/pagination.css' %}">
    <link rel="stylesheet" href="{% static 'css/progress-bar.css' %}">
    <link rel="stylesheet" href="{% static 'css/filters.css' %}">
{% endblock %}

{% block content %}
    <div class="container mt-2">
        {% include "components/header.html" with icon="upload_file" title="Carica Estratti Conto" %}

        <div class="upload-area mb-3">
            <form id="uploadForm" class="file-upload-form" method="POST" enctype="multipart/form-data">
                {% csrf_token %}

                <div class="drop-zone" id="dropZone">
                    <input type="file" id="fileInput" name="file" accept=".csv,.xlsx,.xls" hidden>
                    <p class="drop-zone-text">Carica un file Excel o Csv. Trascina qui il file o <strong class="primary-text-link" id="browseFiles">clicca
                        per selezionare</strong></p>
                    <small class="text-muted">
                        Max 1 file,
                        {% if upload_context %}
                            formati supportati: {{ upload_context.allowed_formats|join:", " }},
                            dimensione massima {{ upload_context.max_file_size_mb }}MB.
                        {% else %}
                            dimensione massima 10MB.
                        {% endif %}
                    </small>
                </div>

                <!-- Display form errors -->
                {% if form.errors %}
                    <div class="alert alert-danger mt-3">
                        <button type="button" class="close-btn" onclick="this.parentElement.remove();" aria-label="Chiudi"><span class="material-icons">close</span></button>
                        {% for field, errors in form.errors.items %}
                            {% for error in errors %}
                                <p>{{ error }}</p>
                            {% endfor %}
                        {% endfor %}
                    </div>
                {% endif %}

                <div class="mt-5" id="fileListContainer">
                    <div id="fileListPreview" class="file-list-preview hidden">
                    </div>
                    <div id="processingProgressBarContainer" class="progress-container mt-3 hidden">
                        <div id="processingProgressBar" class="progress-bar" role="progressbar"  style="width: 0;"
                             aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                            0%
                        </div>
                    </div>
                    {% if not has_pending %}
                    <button type="submit" class="btn btn-primary" id="submitUpload" disabled>
                        Carica File
                    </button>
                    {% else %}
                        <button type="submit" class="btn btn-primary btn-disabled" id="submitUpload" disabled>
                            Carica File
                        </button>
                    {% endif %}

                </div>
            </form>
        </div>

        <h1 class="header"> Tutti i tuoi caricamenti</h1>

        <!-- Filters -->
        <form method="get" class="filters" id="upload-filter-form"
              hx-get="{% url 'transactions_upload' %}"
              hx-target="#upload-results"
              hx-swap="outerHTML settle:500ms"
              hx-indicator="#upload-results"
              hx-trigger="change, input delay:500ms from:#search, submit">

            <div class="filter-main-row">
                <div class="search-group">
                    <div class="search-input-wrapper">
                        <span class="material-icons search-icon">search</span>
                        <input type="text" name="search" id="search" placeholder="Cerca per nome file..."
                               aria-label="Ricerca"
                               value="{{ request.GET.search|default:'' }}"/>
                    </div>
                </div>

                <div class="filter-actions-compact">
                    <button type="button" 
                            class="btn btn-icon btn-subtle filter-toggle-btn {% if request.GET.search or selected_status %}filters-active{% endif %}" 
                            onclick="toggleFilters()"
                            title="Mostra filtri">
                        <span class="material-icons">tune</span>
                        <span class="desktop-only">Filtri</span>
                    </button>


                    <button
                       hx-get="{% url 'transactions_upload' %}"
                       hx-target="#upload-results"
                       hx-swap="outerHTML settle:500ms"
                       hx-indicator="#upload-results"
                       hx-on::before-request="clearFilters('upload-filter-form');"
                       hx-disinherit="*"
                       hx-sync="closest form:replace"
                       class="btn btn-icon btn-subtle" title="Cancella">
                        <span class="material-icons">clear</span>
                    </button>
                </div>
            </div>

            <div class="filter-collapsible-content" id="filter-collapsible">
                <div class="filter-grid">
                    <div class="filter-group">
                        <div class="card-selector-static">
                            <div class="card-content">
                                <div class="card-info">
                                    <div class="card-icon-box">
                                        <span class="material-icons">rule</span>
                                    </div>
                                    <div class="card-text">
                                        <b>Stato</b>
                                        <span>Stato caricamento</span>
                                    </div>
                                </div>
                                <div class="card-action">
                                    <div class="custom-multiselect" id="status-multiselect"
                                         data-placeholder="Tutti gli stati"
                                         data-plural-text="stati selezionati">
                                        <div class="multiselect-trigger card-multiselect-trigger"
                                             onclick="toggleMultiselect('status-multiselect', event)">
                                            <span class="trigger-text">Tutti gli stati</span>
                                            <span class="material-icons">expand_more</span>
                                        </div>
                                        <div class="multiselect-menu">
                                            <label class="multiselect-item {% if 'ready' in selected_status %}is-selected{% endif %}">
                                                <input type="checkbox" name="status" value="ready"
                                                       {% if 'ready' in selected_status %}checked{% endif %}
                                                       onchange="updateMultiselect('status-multiselect')">
                                                <span class="material-icons">check_circle</span>
                                                Completato
                                            </label>
                                            <label class="multiselect-item {% if 'not_ready' in selected_status %}is-selected{% endif %}">
                                                <input type="checkbox" name="status" value="not_ready"
                                                       {% if 'not_ready' in selected_status %}checked{% endif %}
                                                       onchange="updateMultiselect('status-multiselect')">
                                                <span class="material-icons">sync</span>
                                                In corso
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="filter-group">
                        <div class="card-selector-static">
                            <div class="card-content">
                                <div class="card-info">
                                    <div class="card-icon-box">
                                        <span class="material-icons">format_list_numbered</span>
                                    </div>
                                    <div class="card-text">
                                        <b>Righe per pagina</b>
                                        <span>Risultati visibili</span>
                                    </div>
                                </div>
                                <div class="card-action">
                                    <select name="paginate_by" id="paginate_by" class="card-select">
                                        <option value="10" {% if paginate_by == 10 %}selected{% endif %}>10</option>
                                        <option value="25" {% if paginate_by == 25 %}selected{% endif %}>25</option>
                                        <option value="50" {% if paginate_by == 50 %}selected{% endif %}>50</option>
                                        <option value="100" {% if paginate_by == 100 %}selected{% endif %}>100</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </form>

        {% include "transactions/components/upload_list_results.html" %}

    </div>
    <script>
        const CSRF_TOKEN = "{{ csrf_token }}"
        const FILE_UPLOADS_PAGE = "{% url 'transactions_upload' %}"
        const FILE_UPLOAD_PROGRESS = "{% url 'transactions_progress' %}"
        const FILE_UPLOAD_CHECK = "{% url 'transactions_upload_check' %}"
        const EXPORT_DOWNLOAD_ENDPOINT = "{% url 'transaction_export' %}"
    </script>
    <script src="{% static 'js/upload.js' %}"></script>
    <script src="{% static 'js/export.js' %}"></script>
{% endblock %}