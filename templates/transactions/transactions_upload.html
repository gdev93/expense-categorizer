


{% extends "main/index.html" %}

{% load static %}

{% block title %}Caricamento dati{% endblock %}
{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/upload.css' %}">
    <link rel="stylesheet" href="{% static 'css/list.css' %}">
    <link rel="stylesheet" href="{% static 'css/pagination.css' %}">
    <link rel="stylesheet" href="{% static 'css/progress-bar.css' %}">
{% endblock %}

{% block content %}
    <div class="container mt-5">
        {% include "components/header-with-back-to-summary-button.html" with icon="üöö" title="Carica Estratti Conto" %}
        <!-- Display Messages -->
        {% if messages %}
            <div class="messages mb-3">
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        <div class="upload-area mb-3">
            <p class="text-muted mb-5">
                Seleziona un file in formato <strong>CSV</strong> da caricare per l'elaborazione.
                {% if upload_context %}
                    Dimensione massima: <strong>{{ upload_context.max_file_size_mb }}MB</strong>.
                {% endif %}
            </p>


            <form id="uploadForm" class="file-upload-form" method="POST" enctype="multipart/form-data">
                {% csrf_token %}

                <div class="drop-zone" id="dropZone">
                    <input type="file" id="fileInput" name="file" accept=".csv" hidden>
                    <p class="drop-zone-text">Trascina qui il file o <strong class="primary-text-link" id="browseFiles">clicca
                        per selezionare</strong></p>
                    <small class="text-muted">
                        Max 1 file,
                        {% if upload_context %}
                            formati supportati: {{ upload_context.allowed_formats|join:", " }},
                            dimensione massima {{ upload_context.max_file_size_mb }}MB.
                        {% else %}
                            dimensione massima 10MB.
                        {% endif %}
                    </small>
                </div>

                <!-- Display form errors -->
                {% if form.errors %}
                    <div class="alert alert-danger mt-3">
                        {% for field, errors in form.errors.items %}
                            {% for error in errors %}
                                <p>{{ error }}</p>
                            {% endfor %}
                        {% endfor %}
                    </div>
                {% endif %}

                <div class="mt-5" id="fileListContainer">
                    <div id="fileListPreview" class="file-list-preview hidden">
                    </div>
                    <div id="processingProgressBarContainer" class="progress-container mt-3 hidden">
                        <div id="processingProgressBar" class="progress-bar" role="progressbar"  style="width: 0;"
                             aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                            0%
                        </div>
                    </div>
                    {% if not has_pending %}
                    <button type="submit" class="btn btn-primary" id="submitUpload" disabled>
                        Carica CSV
                    </button>
                    {% else %}
                        <button type="submit" class="btn btn-primary btn-disabled" id="submitUpload" disabled>
                            Carica CSV
                        </button>
                    {% endif %}

                </div>
            </form>
        </div>

        <h1 class="header">üöö Tutti i tuoi caricamenti</h1>

        <div class="data-list uploaded-list-padding">
    {% if uploads %}
        {% for upload in uploads %}
            <div class="data-list-item">

                <div class="file-main-info">
                    <div class="file-icon">üìÅ</div>
                    <div class="file-text-content">
                        <div class="file-name">
                            Estrazione_{{ upload.id }}_{{ upload.upload_date|date:"Ymd_His" }}.csv
                        </div>
                        <div class="file-date">
                            üìÖ Caricato il {{ upload.upload_date|date:"d/m/Y H:i" }}
                        </div>
                        <div class="file-size text-muted">
                            {% if upload.dimension %}
                                üíæ {{ upload.file_size_display }}
                            {% endif %}
                            {% if upload.processing_time %}
                                ‚è±Ô∏è {{ upload.processing_time }}ms
                            {% else %}
                               üî• In corso
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="file-meta-info">
                    <span class="upload-status status-completato">
                        {% if upload.status != 'categorized' %}
                        In corso
                        {% else %}
                        Completato
                        {% endif %}
                    </span>

                    <div class="expense-count">
                        <span class="count-number">{{ upload.transactions_count }}</span> Spese trovate
                    </div>
                    <form action="{% url 'transactions_upload_delete' upload.id %}" method="post">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger btn-sm">
                            Elimina
                        </button>
                    </form>
                </div>
            </div>
        {% endfor %}
    {% else %}
        <div class="empty-state">
            <p class="text-muted">üì≠ Nessun caricamento trovato. Carica il tuo primo file CSV!</p>
        </div>
    {% endif %}
</div>

        <!-- Pagination -->
        {% if is_paginated %}
            <div class="pagination mt-4">
                {% if page_obj.has_previous %}
                    <a href="?page=1" class="pagination-link">&laquo; Prima</a>
                    <a href="?page={{ page_obj.previous_page_number }}" class="pagination-link">Precedente</a>
                {% endif %}

                <span class="pagination-current">
                    Pagina {{ page_obj.number }} di {{ page_obj.paginator.num_pages }}
                </span>

                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}" class="pagination-link">Successiva</a>
                    <a href="?page={{ page_obj.paginator.num_pages }}" class="pagination-link">Ultima &raquo;</a>
                {% endif %}
            </div>
        {% endif %}

    </div>
    <script>
        const CSRF_TOKEN = "{{ csrf_token }}"
        const CSV_UPLOADS_PAGE = "{% url 'transactions_upload' %}"
        const CSV_UPLOAD_PROCESS = "{% url 'transactions_process' %}"
        const CSV_UPLOAD_PROGRESS = "{% url 'transactions_progress' %}"
        const CSV_UPLOAD_CHECK = "{% url 'transactions_upload_check' %}"
    </script>
    <script src="{% static 'js/upload.js' %}"></script>
{% endblock %}