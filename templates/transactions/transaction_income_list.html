{% extends "main/index.html" %}
{% load static %}

{% block title %}Entrate{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/transactions.css' %}">
    <link rel="stylesheet" href="{% static 'css/list.css' %}">
    <link rel="stylesheet" href="{% static 'css/pagination.css' %}">
    <link rel="stylesheet" href="{% static 'css/layout.css' %}">
    <link rel="stylesheet" href="{% static 'css/filters.css' %}">
{% endblock %}

{% block content %}
    <div class="container mt-2">

        {% include "components/header-with-year-select.html" with icon="ğŸ’°" title="Entrate" %}

        {% if transactions %}
            <div class="summary">
                {% include "components/summary-card.html" with label="Importo Totale" value=total_amount|floatformat:2 currency="â‚¬" %}
                {% include "components/summary-card.html" with label="Totale Entrate" value=total_count %}
            </div>
        {% endif %}

        <!-- Filters (no category filter for incomes) -->
        <form method="get" class="filters">
            <div class="filter-group">
                <label for="amount">ğŸ’° Importo</label>
                <div class="amount-filter-wrapper">
                    <select name="amount_operator" id="amount_operator" class="amount-operator">
                        <option value="eq" {% if selected_amount_operator == "eq" %}selected{% endif %}>=</option>
                        <option value="gt" {% if selected_amount_operator == "gt" %}selected{% endif %}>&gt;</option>
                        <option value="gte" {% if selected_amount_operator == "gte" %}selected{% endif %}>&gt;=</option>
                        <option value="lt" {% if selected_amount_operator == "lt" %}selected{% endif %}>&lt;</option>
                        <option value="lte" {% if selected_amount_operator == "lte" %}selected{% endif %}>&lt;=</option>
                    </select>
                    <input type="number"
                           name="amount"
                           id="amount"
                           class="amount-input"
                           placeholder="0.00"
                           step="0.01"
                           min="0"
                           value="{{ selected_amount }}"/>
                </div>
            </div>

            <div class="filter-group">
                <label for="months">ğŸ“… Mese/i</label>
                <select name="months" id="months" multiple size="1" onchange="this.form.submit()">
                    <option value="">Tutti i Mesi</option>
                    {% for month in available_months %}
                        <option value="{{ month.month_number }}"
                                {% if month.month_number|stringformat:"s" in selected_months %}selected{% endif %}>
                            {{ month.label_it }}
                        </option>
                    {% endfor %}
                </select>
                <small class="form-text text-muted desktop-only" style="font-size: 0.75rem; margin-top: 4px;">
                    Tieni premuto Ctrl (Windows) o Cmd (Mac) per selezionare piÃ¹ mesi
                </small>
            </div>

            <div class="filter-group">
                <label for="search">ğŸ” Ricerca</label>
                <input type="text" name="search" id="search" placeholder="Cerca descrizione..."
                       value="{{ search_query }}"/>
            </div>

            <div class="filter-group" style="align-self: flex-end;">
                <button type="submit" class="btn btn-primary">Filtra</button>
                <a href="{% url 'income_list' %}" class="btn btn-secondary">Cancella</a>
            </div>
        </form>

        <!-- Income List -->
        {% if transactions %}
            <h2 class="mb-3">ğŸ“Š Entrate</h2>

            <div class="data-list" id="scroll-target">
                {% for transaction in transactions %}
                    <div class="data-list-item">
                        <div class="transaction-main">
                            <div class="transaction-date">
                                ğŸ“… {{ transaction.transaction_date|date:"d/m/Y" }}
                            </div>
                        <div class="transaction-merchant">
                                {{ transaction.operation_type }}
                            </div>
                            {% if transaction.description %}
                                <div class="transaction-description" title="{{ transaction.description }}">
                                    {{ transaction.description|truncatewords:15 }}
                                </div>
                            {% endif %}
                        </div>

                        <div class="transaction-meta">
                            <div class="transaction-amount">
                                â‚¬{{ transaction.amount|floatformat:2 }}
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>

            <!-- Pagination -->
            {% if is_paginated %}
                <div class="pagination">
                    {% if page_obj.has_previous %}
                        <a href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}{% for month in selected_months %}&months={{ month }}{% endfor %}">Â« Prima</a>
                        <a href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% for month in selected_months %}&months={{ month }}{% endfor %}">â€¹ Precedente</a>
                    {% else %}
                        <span class="disabled">Â« Prima</span>
                        <span class="disabled">â€¹ Precedente</span>
                    {% endif %}

                    <span class="current">
                        Pagina {{ page_obj.number }} di {{ page_obj.paginator.num_pages }}
                    </span>

                    {% if page_obj.has_next %}
                        <a href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% for month in selected_months %}&months={{ month }}{% endfor %}">Successiva â€º</a>
                        <a href="?page={{ page_obj.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}{% for month in selected_months %}&months={{ month }}{% endfor %}">Ultima Â»</a>
                    {% else %}
                        <span class="disabled">Successiva â€º</span>
                        <span class="disabled">Ultima Â»</span>
                    {% endif %}
                </div>
            {% endif %}

        {% else %}
            <p class="text-muted" style="margin-top: 16px;">Nessuna entrata trovata.</p>
        {% endif %}

    </div>

{% endblock %}
