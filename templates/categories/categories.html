{% extends "main/index.html" %}
{% load static %}

{% block title %}Gestione Categorie{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/layout.css' %}">
    <link rel="stylesheet" href="{% static 'css/list.css' %}">
    <link rel="stylesheet" href="{% static 'css/main.css' %}">
    <link rel="stylesheet" href="{% static 'css/categories.css' %}">
    <link rel="stylesheet" href="{% static 'css/filters.css' %}">
{% endblock %}

{% block content %}
<div class="container mt-2">

    <div class="sticky-header-bar" id="stickyHeader">
        <div class="header-main-content">
            {% include "components/header-categories.html" with title="Categorie" icon="category"%}
        </div>
    </div>

    <form method="get" class="filters" action="{% url 'category_list' %}" id="main-filter-form">
        <div class="filter-actions">
            <button type="submit" class="btn btn-icon btn-subtle-primary" title="Filtra"><span class="material-icons">search</span></button>
            <a href="{% url 'category_list' %}" class="btn btn-icon btn-subtle-danger" id="delete-category-search" title="Cancella"><span class="material-icons">clear</span></a>
            <button type="button" class="btn btn-icon btn-subtle-success" onclick="exportCategories()" title="Esporta"><span class="material-icons">download</span></button>
        </div>

        <div class="filter-group w-100-mobile">
            <label for="categories">Categorie</label>
            <select name="categories" id="categories" multiple size="1" onchange="debounceFormSubmit(this.form)">
                <option value="">Tutte le Categorie</option>
                {% for cat in all_categories %}
                    <option value="{{ cat.id }}"
                            {% if cat.id|stringformat:"s" in selected_categories %}selected{% endif %}>
                        {{ cat.name }}
                    </option>
                {% endfor %}
            </select>
            <small class="form-text text-muted desktop-only" style="font-size: 0.75rem; margin-top: 4px;">
                Tieni premuto Ctrl (Windows) o Cmd (Mac) per selezionare più categorie
            </small>
        </div>

        <div class="filter-group w-100-mobile">
            <label for="months">Mese/i</label>
            <select name="months" id="months" multiple size="1" onchange="debounceFormSubmit(this.form)">
                <option value="">Tutti i mesi</option>
                {% for available_month in available_months %}
                    <option value="{{ available_month.month_number }}"
                            {% if available_month.month_number|stringformat:"s" in selected_months %}selected{% endif %}>
                        {{ available_month.label_it }}
                    </option>
                {% endfor %}
            </select>
            <small class="form-text text-muted desktop-only" style="font-size: 0.75rem; margin-top: 4px;">
                Tieni premuto Ctrl (Windows) o Cmd (Mac) per selezionare più mesi
            </small>
        </div>

    </form>

    <div class="category-layout-stacked">
        <div class="category-list-section">
            {% if categories %}
            <div class="data-list">
                {% for category in categories %}
                    <div class="data-list-item" onclick="window.location.href='{% url 'category_detail' category.id %}?year={{ year }}{% for m in selected_months %}&months={{ m }}{% endfor %}'">
                        <div class="list-item-info">
                            <span class="category-name">{{ category.name }}</span>
                            {% if category.description %}
                                <p class="category-description">{{ category.description|truncatechars:100 }}</p>
                            {% else %}
                                <p class="category-description text-muted"><em>Nessuna descrizione</em></p>
                            {% endif %}
                        </div>

                        <div class="list-item-stats">
                            <span class="list-amount">€ {{ category.transaction_amount|floatformat:2|default:"0,00" }}</span>
                            <span class="badge-count">{{ category.transaction_count|default:"0" }} transazioni</span>
                        </div>
                    </div>
                {% endfor %}
            </div>
            {% else %}
                <div class="empty-state-simple">
                    <p>Non hai ancora creato nessuna categoria.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script src="{% static 'js/categories.js' %}"></script>
<script src="{% static 'js/reset-filter.js' %}"></script>
<script>
    function exportCategories() {
        const form = document.getElementById('main-filter-form');
        const formData = new FormData(form);
        const params = new URLSearchParams();

        for (const [key, value] of formData.entries()) {
            if (value) {
                if (key === 'categories' || key === 'months') {
                    params.append(key, value);
                } else {
                    params.set(key, value);
                }
            }
        }

        const url = "{% url 'category_export' %}?" + params.toString();
        window.location.href = url;
    }
</script>
{% endblock %}