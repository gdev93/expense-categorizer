{% extends "main/index.html" %}
{% load static %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/categories.css' %}">
    <link rel="stylesheet" href="{% static 'css/list.css' %}">
    <link rel="stylesheet" href="{% static 'css/category-confirm-delete.css' %}">
{% endblock %}

{% block content %}
    <div class="container mt-2">

        {% include "components/header-with-back-to-category-button.html" with title="Elimina Categoria" category_summary=object hide_delete=True %}

        <div class="form-container-small mt-4">
            <div class="category-form-section">
                <p class="mb-3">Sei sicuro di voler eliminare definitivamente la categoria <strong>"{{ object.name }}"</strong>?</p>

                <div class="alert alert-warning mb-4">
                    <strong>Attenzione:</strong> Questa azione è <strong>irreversibile</strong>.
                    Devi riassegnare tutte le transazioni e le regole a un'altra categoria.
                </div>

                <form method="post" id="delete-category-form">
                    {% csrf_token %}
                    
                    <div class="category-selection-wrapper">
                        <label class="section-title">Scegli la categoria di destinazione:</label>

                        <!-- New Category Option -->
                        <div class="category-card new-card selected" id="new-card">
                            <input type="radio" name="replacement_category" value="" id="radio_new" checked>
                            <div class="card-content">
                                <label for="radio_new">Crea una nuova categoria</label>
                                <div class="new-category-input-wrapper">
                                    <input type="text" name="new_category_name" id="new_category_name" 
                                           class="form-control" placeholder="Esempio: Varie, Altro..." autofocus>
                                </div>
                            </div>
                        </div>

                        <div class="divider-text">
                            <span class="small text-uppercase fw-bold">oppure seleziona una esistente</span>
                        </div>

                        <div class="search-container">
                            <span class="search-icon"></span>
                            <input type="text" id="category-search" class="form-control" placeholder="Cerca categoria...">
                        </div>

                        <div class="category-scroll-area" id="category-list">
                            {% for cat in other_categories %}
                                <div class="category-card existing-card">
                                    <input type="radio" name="replacement_category" value="{{ cat.pk }}" id="cat_{{ cat.pk }}">
                                    <div class="card-content">
                                        <label for="cat_{{ cat.pk }}" class="category-name-label">{{ cat.name }}</label>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="form-actions d-flex gap-3 justify-content-center mt-4">
                        <button type="submit" class="btn btn-danger">Sì, Elimina e Riassegna</button>
                        <a href="{% url 'category_detail' object.id %}" class="btn btn-secondary">Annulla</a>
                    </div>
                </form>

                <script>
                    // Handle initial state
                    document.addEventListener('DOMContentLoaded', function() {
                        const selectedRadio = document.querySelector('input[name="replacement_category"]:checked');
                        if (selectedRadio) {
                            const card = selectedRadio.closest('.category-card');
                            // Reset all and set current
                            document.querySelectorAll('.category-card').forEach(c => c.classList.remove('selected'));
                            card.classList.add('selected');
                            
                            const newCatInput = document.getElementById('new_category_name');
                            if (selectedRadio.value === '') {
                                newCatInput.disabled = false;
                            } else {
                                newCatInput.disabled = true;
                            }
                        }
                    });

                    // Handle card clicks
                    document.querySelectorAll('.category-card').forEach(card => {
                        card.addEventListener('click', function(e) {
                            // Don't trigger if clicking the text input itself
                            if (e.target.tagName === 'INPUT' && e.target.type === 'text') return;
                            
                            const radio = this.querySelector('input[type="radio"]');
                            radio.checked = true;
                            
                            // Update UI classes
                            document.querySelectorAll('.category-card').forEach(c => c.classList.remove('selected'));
                            this.classList.add('selected');
                            
                            const newCatInput = document.getElementById('new_category_name');
                            if (this.id === 'new-card') {
                                newCatInput.disabled = false;
                                newCatInput.focus();
                            } else {
                                newCatInput.disabled = true;
                            }
                        });
                    });

                    // Search filtering
                    document.getElementById('category-search').addEventListener('input', function(e) {
                        const term = e.target.value.toLowerCase();
                        document.querySelectorAll('.existing-card').forEach(card => {
                            const name = card.querySelector('.category-name-label').textContent.toLowerCase();
                            if (name.includes(term)) {
                                card.style.display = 'flex';
                            } else {
                                card.style.display = 'none';
                            }
                        });
                    });

                    // Form validation
                    document.getElementById('delete-category-form').addEventListener('submit', function(e) {
                        const selectedRadio = document.querySelector('input[name="replacement_category"]:checked');
                        const newCatNameField = document.getElementById('new_category_name');
                        const newCatName = newCatNameField.value.trim();
                        
                        if (selectedRadio && selectedRadio.value === '' && !newCatName) {
                            e.preventDefault();
                            showAlert('Per favore, inserisci un nome per la nuova categoria.');
                            newCatNameField.focus();
                        } else if (!selectedRadio) {
                            e.preventDefault();
                            showAlert('Per favore, seleziona una categoria esistente o creane una nuova.');
                        }
                    });
                </script>
            </div>
        </div>
    </div>
{% endblock %}